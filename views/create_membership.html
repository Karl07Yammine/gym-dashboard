<!doctype html>
<html lang="en">
<head>
   <meta charset="UTF-8"/>
   <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
   <title>Create Membership</title>
   <link rel="stylesheet" href="/css/styles.css"/>
   <meta name="theme-color" content="#0b0f14">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   <style>
      :root{
        --bg:#0b0f14; --card:#0f1624; --line:#233044; --text:#e8eef7; --muted:#9fb0c7;
        --accent:#4da3ff; --accent-2:#2d7fe0; --good:#1f6e41; --bad:#6e1f2b;
        --radius:14px;
      }
      html,body{height:100%}
      body.bg{
        margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
        background:linear-gradient(180deg,#0b0f14,#0d1422 100%); color:var(--text);
      }
      .topbar{
        display:flex; align-items:center; justify-content:space-between;
        padding:12px 16px; border-bottom:1px solid var(--line);
        position:sticky; top:0; backdrop-filter:saturate(120%) blur(6px);
        background:rgba(11,15,20,.65);
      }
      .brand{font-weight:700}
      nav{display:flex; gap:8px}
      .btn-outline{
        border:1px solid var(--line); color:var(--text); text-decoration:none; padding:8px 12px; border-radius:10px; font-size:14px;
      }
      .container{max-width:560px; margin:24px auto; padding:0 16px}
      .card{
        background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
        padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.25);
      }
      h2{margin:0 0 12px; font-size:20px}

      form{display:grid; gap:10px}
      label{font-size:13px; color:var(--muted)}
      input[type="text"], input[type="number"]{
        width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0c1320; color:var(--text); font-size:14px;
      }
      input:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(77,163,255,.15)}

      .membership-type{display:flex; gap:10px; margin:6px 0 2px}
      .membership-type input[type="radio"]{display:none}
      .chip{
        flex:1; padding:12px; border:1px solid var(--line); border-radius:12px; background:#0c1320; text-align:center; font-size:14px; cursor:pointer;
        transition:transform .05s ease, border-color .15s ease, background .15s ease;
        user-select:none;
      }
      .chip:hover{transform:translateY(-1px)}
      #daily:checked + label, #monthly:checked + label{
        border-color:var(--accent); background:#10233f;
      }

      .months-wrap{
        overflow:hidden; transition:max-height .18s ease;
        max-height:0;
      }
      .months-wrap.show{max-height:120px}

      .btn{
        padding:10px 14px; background:var(--accent); color:#08101d; border:none; border-radius:12px; font-weight:600; cursor:pointer;
      }
      .btn:hover{background:var(--accent-2)}
      .btn[disabled]{opacity:.6; cursor:not-allowed}

      .hint{color:var(--muted); font-size:13px; margin-top:8px}
      .status{
        padding:10px; border-radius:10px; border:1px solid var(--line); background:#0c1320; font-size:13px; margin-top:12px;
      }
      .status.success{border-color:rgba(31,110,65,.5)}
      .status.error{border-color:rgba(110,31,43,.55); color:#ffdbe0}
   </style>
</head>
<body class="bg">
   <div class="topbar">
      <div class="brand">SkyGym</div>
      <nav>
         <a class="btn-outline" href="/dashboard">Scanner</a>
         <a class="btn-outline" href="/create-user">Create User</a>
      </nav>
   </div>

   <div class="container">
      <div class="card">
         <h2>Create Membership</h2>
         <form id="membershipForm" novalidate>
            <label>Member ID (6 digits)</label>
            <input id="userId" name="user_id" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="000123" required />

            <label>Membership Type</label>
            <div class="membership-type">
               <input type="radio" id="daily" name="type" value="daily" checked>
               <label for="daily" class="chip">Daily Pass</label>

               <input type="radio" id="monthly" name="type" value="monthly">
               <label for="monthly" class="chip">Monthly</label>
            </div>

            <div class="months-wrap" id="monthsWrap" aria-hidden="true">
               <label>Number of Months</label>
               <input id="months" name="months" type="number" min="1" max="12" value="1" />
            </div>

            <button class="btn" id="submitBtn" type="submit">Create Membership</button>
         </form>

         <p class="hint">Daily = 24 hours from purchase. Monthly extends by whole months from today.</p>
         <div id="statusBox" class="status" style="display:none;"></div>
      </div>
   </div>

   <script>
      const form = document.getElementById('membershipForm');
      const statusBox = document.getElementById('statusBox');
      const monthsWrap = document.getElementById('monthsWrap');
      const dailyRadio = document.getElementById('daily');
      const monthlyRadio = document.getElementById('monthly');
      const submitBtn = document.getElementById('submitBtn');
      const userIdEl = document.getElementById('userId');
      const monthsEl = document.getElementById('months');

      function showMonths(){
        const show = monthlyRadio.checked;
        monthsWrap.classList.toggle('show', show);
        monthsWrap.setAttribute('aria-hidden', String(!show));
      }
      dailyRadio.addEventListener('change', showMonths);
      monthlyRadio.addEventListener('change', showMonths);
      showMonths();

      // keep input strictly numeric (6 digits)
      userIdEl.addEventListener('input', () => {
        userIdEl.value = userIdEl.value.replace(/\D/g,'').slice(0,6);
      });

      function setStatus(message, type){
        statusBox.style.display = 'block';
        statusBox.className = 'status ' + (type || '');
        statusBox.textContent = message;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = userIdEl.value.trim();
        const type = document.querySelector('input[name="type"]:checked').value;
        const months = parseInt(monthsEl.value || '1', 10);

        if (!/^\d{6}$/.test(userId)) {
          setStatus('Member ID must be exactly 6 digits.', 'error');
          return;
        }
        if (type === 'monthly' && !(months >= 1 && months <= 12)) {
          setStatus('Months must be between 1 and 12.', 'error');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating…';
        setStatus('Creating membership…');

        try {
          const endpoint = type === 'daily' ? '/api/passes/daily' : '/api/memberships/monthly';
          const body = type === 'daily'
            ? { user_id: userId }
            : { user_id: userId, months };

          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data.ok) {
            setStatus(data.message || 'Failed to create membership.', 'error');
            return;
          }

          const end = data.membership?.endAt ? new Date(data.membership.endAt) : null;
          const endDate = end ? end.toLocaleDateString() : '(unknown date)';
          const msg = type === 'daily'
            ? `Daily pass created for ${userId}. Expires ${endDate}.`
            : `${months} month${months>1?'s':''} membership created for ${userId}. Expires ${endDate}.`;

          setStatus(msg, 'success');
          form.reset();
          showMonths();
        } catch (err) {
          setStatus('Server error: ' + err, 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create Membership';
        }
      });
   </script>
</body>
</html>
